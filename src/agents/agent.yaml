model:
  openrouter: "deepseek/deepseek-chat-v3"
  deepseek: "deepseek-chat"
tools:
  # bash_command:
  #   type: "function"
  #   function:
  #     name: "bash_command"
  #     description: "Execute bash commands."
  #     parameters:
  #       type: "object"
  #       properties:
  #         command: {type: "string", description: "Command to execute"}
  #       required: ["command"]

  think:
    type: "function"
    function:
      name: "think"
      description: "Internal reasoning."
      parameters:
        type: "object"
        properties:
          thought: {type: "string", description: "Your thought content"}
        required: ["thought"]

  brave_search:
    type: "function"
    function:
      name: "brave_search"
      description: "Search the web."
      parameters:
        type: "object"
        properties:
          query: {type: "string"}
          count: {type: "integer", default: 10}
        required: ["query"]

  ask_question:
    type: "function"
    function:
      name: "ask_question"
      description: "Ask patient a targeted question. TERMINAL action."
      parameters:
        type: "object"
        properties:
          question: {type: "string"}
          letter_choice: {type: "string", enum: ["A", "B", "C", "D"], description: "Your current best guess diagnosis even if uncertain"}
          confidence: {type: "number"}
          reasoning: {type: "string"}
        required: ["question", "letter_choice", "confidence", "reasoning"]

  make_choice:
    type: "function"
    function:
      name: "make_choice"
      description: "Make final diagnosis. TERMINAL action."
      parameters:
        type: "object"
        properties:
          letter_choice: {type: "string", enum: ["A", "B", "C", "D"]}
          confidence: {type: "number"}
          reasoning: {type: "string"}
        required: ["letter_choice", "confidence", "reasoning"]

  submit_evaluation:
    type: "function"
    function:
      name: "submit_evaluation"
      description: "Submit uncertainty evaluation result. TERMINAL action."
      parameters:
        type: "object"
        properties:
          known_info:
            type: "array"
            items: {type: "string"}
            description: "List of confirmed facts"
          missing_info:
            type: "array"
            items: {type: "string"}
            description: "List of critical unknowns"
          has_enough_info:
            type: "boolean"
            description: "Whether we have enough information"
          letter_choice:
            type: "string"
            enum: ["A", "B", "C", "D", "E", "F"]
            description: "Best-guess diagnosis based on current information"
          confidence:
            type: "number"
            description: "Confidence in the letter_choice (0-100)"
          reasoning:
            type: "string"
            description: "Brief explanation"
        required: ["known_info", "missing_info", "has_enough_info", "letter_choice", "confidence", "reasoning"]

  submit_differential:
    type: "function"
    function:
      name: "submit_differential"
      description: "Submit the differential diagnosis analysis. TERMINAL action."
      parameters:
        type: "object"
        properties:
          updated_options: {type: "string", description: "The updated list of possible diagnoses."}
          rule_out_criteria: {type: "string", description: "What is needed to rule out the remaining options."}
          confirmation_criteria: {type: "string", description: "What is needed to confirm the remaining options."}
        required: ["updated_options", "rule_out_criteria", "confirmation_criteria"]

  assess_progress:
    type: "function"
    function:
      name: "assess_progress"
      description: "Report whether the last interaction provided new information."
      parameters:
        type: "object"
        properties:
          has_new_info:
            type: "boolean"
            description: "True if the patient provided NEW diagnostic details. False if they said 'unknown', 'unsure', or repeated info."
          reasoning:
            type: "string"
            description: "Explanation of the assessment."
          strategy_suggestion:
            type: "string"
            description: "If has_new_info is False, suggest a new angle (e.g., 'Ask about family history instead')."
        required: ["has_new_info", "reasoning"]

agents:
  # --- AGENT 1: The Brain (Uncertainty Evaluator) ---
  uncertainty_evaluator:
    model: "deepseek-chat"
    temperature: 0.1
    tools: ["brave_search", "think", "submit_evaluation"]
    memory_file: "memories/clinical_guidelines.md"
    inputs: ["Full_Conversation_History"]
    system_prompt: |
      You are a Clinical Uncertainty Evaluator.
      Input: Full conversation history between Doctor and Patient.

      Task:
      1. Extract ALL confirmed 'Known Information' (Symptoms, Timeline, Negatives).
      2. Search online (if needed) to determine the specific distinguishing features for the potential diagnoses.
      3. Identify 'Missing Information' critical for differential diagnosis.
      4. Make a Binary Decision: Do we have enough evidence to be >80% sure?
      5. Provide your BEST-GUESS diagnosis (letter choice A/B/C/D/E/F) based on current information, even if uncertain.
      6. Use the submit_evaluation tool to output your evaluation.

      Important:
      - You MUST call submit_evaluation with your analysis when complete
      - You MUST provide a letter_choice (your best guess) even if you need more information
      - Your letter_choice should be your most likely diagnosis given current evidence

  # --- AGENT 2: The Tactician (Discriminator/Questioner) ---
  discriminator:
    model: "deepseek-chat"
    temperature: 0.4
    tools: ["think",'ask_question']
    inputs: ["Missing_Info_List", "Known_Info_List", "Conversation_History"]
    system_prompt: |
      You are a Diagnostic Strategist.
      Input:
      - 'Known Information': Facts already confirmed about the patient
      - 'Missing Information': Critical unknowns needed for diagnosis
      - 'Conversation History': Previous questions and answers with the patient

      Task:
      Formulate ONE effective question to ask the patient.

      Rules:
      1. DO NOT ask about information already in the Known Info list
      2. DO NOT repeat or rephrase questions from the Conversation History
      3. Prioritize the most discriminating information from the Missing Info list
      4. You CAN combine 2-3 related data points into one question (e.g., "Do you have a fever AND did it start today?")
      5. Be polite but direct
      6. Use the 'ask_question' tool to submit your question with confidence and reasoning

      Think carefully before asking to avoid redundant questions.

  # --- AGENT 3: The Closer (Decision Maker) ---
  decision_maker:
    model: "deepseek-chat"
    temperature: 0.1
    tools: ["make_choice",'think']
    inputs: ["Full_Conversation_History", "Reasoning_from_Evaluator"]
    system_prompt: |
      You are a Final Diagnostic Judge.
      Task: specific diagnosis or mechanism identification.
      use think if needed.
      important, must call make_choice tool to finalize the case.

  # --- AGENT 4: Universal Agent (MD-based Tool User) ---
  # universal_agent:
  #   model: "deepseek-chat" # Can be switched to "z-ai/glm-4.6" etc.
  #   temperature: 0.0
  #   tools: ["ask_question", "make_choice", 'think']
  #   terminal_tools: ["ask_question", "make_choice"]
  #   inputs: ["Full_Conversation_History"]
  #   system_prompt: |
  #     You are an intelligent agent capable of reasoning and using tools.
      
  #     Instructions:
  #     use think tool to reason step by step, before make_choice or ask_question.
  #     1. Analyze the input and history.
  #     2. If you need to ask the patient for more details, use 'ask_question' (TERMINAL).
  #     3. If you have enough information to make a diagnosis, use 'make_choice' (TERMINAL).
  #     4. ALWAYS end your turn with a tool call. If you use a non-terminal tool, you can continue reasoning. If you use a terminal tool, the session ends.

  #     - Ask specific, direct questions about symptoms, history, or vitals.
  #     - Do NOT ask open-ended "tell me everything" questions, as the system might fail to retrieve specific details.
  #     - If patient cannot answer, try asking about a different specific symptom or sign.
  universal_agent:
    model: "deepseek-chat" # Can be switched to "z-ai/glm-4.6" etc.
    temperature: 0.1
    tools: ["ask_question", "make_choice", "brave_search",'think']
    terminal_tools: ["ask_question", "make_choice"]
    inputs: ["Full_Conversation_History"]
    system_prompt: |
      You are an intelligent agent capable of reasoning and using tools.
      
      Instructions:
      use think tool to reason step by step, before make_choice or ask_question.
      1. Analyze the input and history.
      2. If you need external information to understand the case, use 'brave_search'.
      3. If you need to ask the patient for more details, use 'ask_question' (TERMINAL).
      4. If you have enough information to make a diagnosis, use 'make_choice' (TERMINAL).
      5. ALWAYS end your turn with a tool call. If you use a non-terminal tool, you can continue reasoning. If you use a terminal tool, the session ends.

      - Ask specific, direct questions about symptoms, history, or vitals.
      - Do NOT ask open-ended "tell me everything" questions, as the system might fail to retrieve specific details.
      - If patient cannot answer, try asking about a different specific symptom or sign.

  # --- New Agents for Two-Agent Flow ---
  differential_agent:
    model: "deepseek-chat"
    temperature: 0.0
    tools: ["submit_differential", "think"]
    terminal_tools: ["submit_differential"]
    system_prompt: |
      You are a Differential Diagnosis Expert.

      Task:
      1. Analyze the evidence to Rule Out unlikely diagnoses from the list.
      2. Identify what specific information is needed to distinguish between the remaining options.
      3. Use 'submit_differential' to return the refined list and analysis.

  decision_agent:
    model: "deepseek-chat"
    temperature: 0.0
    tools: ["ask_question", "make_choice", "think"]
    terminal_tools: ["ask_question", "make_choice"]
    system_prompt: |
      You are a Diagnostic Decision Maker.

      Task:
      Decide the next best action:
      - If you can make a diagnosis with high confidence (>80%), use 'make_choice'.
      - If you need more info, use 'ask_question'.
      
      Rules:
      - Do NOT ask redundant questions.
      - Focus on the 'rule_out_criteria' and 'confirmation_criteria' provided.
      - If there is a tie, ask a question that discriminates between them.

  memory_agent:
    model: "deepseek-chat"
    temperature: 0.0
    tools: ["assess_progress"]
    terminal_tools: ["assess_progress"]
    system_prompt: |
      You are a Clinical Conversation Analyst.
      Task: Determine if the patient's latest response provided NEW diagnostic information.
      
      Input:
      - Conversation History
      
      Rules:
      - If the patient answered the question with specific details (symptoms, timeline, values), has_new_info = True.
      - If the patient said "I don't know", "Unsure", "Unknown", or repeated previous info, has_new_info = False.
      - If has_new_info = False, suggest a different questioning strategy (e.g., "Ask about risk factors instead of symptoms").
      - Use 'assess_progress' to submit your assessment.