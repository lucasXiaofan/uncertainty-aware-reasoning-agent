model:
  openrouter: "deepseek/deepseek-chat-v3"
  deepseek: "deepseek-chat"
tools:
  bash_command:
    type: "function"
    function:
      name: "bash_command"
      description: "Execute bash commands."
      parameters:
        type: "object"
        properties:
          command: {type: "string", description: "Command to execute"}
        required: ["command"]

  think:
    type: "function"
    function:
      name: "think"
      description: "Internal reasoning."
      parameters:
        type: "object"
        properties:
          thought: {type: "string", description: "Your thought content"}
        required: ["thought"]

  brave_search:
    type: "function"
    function:
      name: "brave_search"
      description: "Search the web."
      parameters:
        type: "object"
        properties:
          query: {type: "string"}
          count: {type: "integer", default: 10}
        required: ["query"]

  ask_question:
    type: "function"
    function:
      name: "ask_question"
      description: "Ask patient a targeted question. TERMINAL action."
      parameters:
        type: "object"
        properties:
          question: {type: "string"}
          letter_choice: {type: "string", enum: ["A", "B", "C", "D"], description: "Your current best guess diagnosis even if uncertain"}
          confidence: {type: "number"}
          reasoning: {type: "string"}
        required: ["question", "letter_choice", "confidence", "reasoning"]

  make_choice:
    type: "function"
    function:
      name: "make_choice"
      description: "Make final diagnosis. TERMINAL action."
      parameters:
        type: "object"
        properties:
          letter_choice: {type: "string", enum: ["A", "B", "C", "D"]}
          confidence: {type: "number"}
          reasoning: {type: "string"}
        required: ["letter_choice", "confidence", "reasoning"]

  submit_evaluation:
    type: "function"
    function:
      name: "submit_evaluation"
      description: "Submit uncertainty evaluation result. TERMINAL action."
      parameters:
        type: "object"
        properties:
          known_info:
            type: "array"
            items: {type: "string"}
            description: "List of confirmed facts"
          missing_info:
            type: "array"
            items: {type: "string"}
            description: "List of critical unknowns"
          has_enough_info:
            type: "boolean"
            description: "Whether we have enough information"
          letter_choice:
            type: "string"
            enum: ["A", "B", "C", "D", "E", "F"]
            description: "Best-guess diagnosis based on current information"
          confidence:
            type: "number"
            description: "Confidence in the letter_choice (0-100)"
          reasoning:
            type: "string"
            description: "Brief explanation"
        required: ["known_info", "missing_info", "has_enough_info", "letter_choice", "confidence", "reasoning"]

  submit_differential:
    type: "function"
    function:
      name: "submit_differential"
      description: "Submit the differential diagnosis analysis. TERMINAL action."
      parameters:
        type: "object"
        properties:
          current_differential_options: {type: "string", description: "The updated list of possible diagnoses. Must be in 'A. Option Name, B. Option Name' format. If uncertain, list all options."}
          rule_out_criteria: {type: "string", description: "What is needed to rule out the remaining options. Must include option label and name (e.g., 'For A. [Name]: ...')."}
          confirmation_criteria: {type: "string", description: "What is needed to confirm the remaining options. Must include option label and name (e.g., 'For A. [Name]: ...')."}
        required: ["current_differential_options", "rule_out_criteria", "confirmation_criteria"]

  assess_progress:
    type: "function"
    function:
      name: "assess_progress"
      description: "Report whether the last interaction provided new information."
      parameters:
        type: "object"
        properties:
          has_new_info:
            type: "boolean"
            description: "True if the patient provided NEW diagnostic details. False if they said 'unknown', 'unsure', or repeated info."
          reasoning:
            type: "string"
            description: "Explanation of the assessment."
          strategy_suggestion:
            type: "string"
            description: "If has_new_info is False, suggest a new angle (e.g., 'Ask about family history instead')."
        required: ["has_new_info", "reasoning"]

agents:
  # --- AGENT 4: Universal Agent (MD-based Tool User) ---
  universal_agent:
    model: "deepseek-chat" # Can be switched to "z-ai/glm-4.6" etc.
    temperature: 0.0
    tools: ["ask_question", "make_choice", 'think']
    terminal_tools: ["ask_question", "make_choice"]
    inputs: ["Full_Conversation_History"]
    system_prompt: |
      You are an intelligent agent capable of reasoning and using tools.
      
      Instructions:
      use think tool to reason step by step, before make_choice or ask_question.
      1. Analyze the input and history.
      2. If you need to ask the patient for more details, use 'ask_question' (TERMINAL).
      3. If you have enough information to make a diagnosis, use 'make_choice' (TERMINAL).
      4. ALWAYS end your turn with a tool call. If you use a non-terminal tool, you can continue reasoning. If you use a terminal tool, the session ends.

      - Ask specific, direct questions about symptoms, history, or vitals.
      - Do NOT ask open-ended "tell me everything" questions, as the system might fail to retrieve specific details.
      - If patient cannot answer, try asking about a different specific symptom or sign.
  # universal_agent:
  #   model: "deepseek-chat" # Can be switched to "z-ai/glm-4.6" etc.
  #   temperature: 0.1
  #   tools: ["ask_question", "make_choice", "brave_search",'think']
  #   terminal_tools: ["ask_question", "make_choice"]
  #   inputs: ["Full_Conversation_History"]
  #   system_prompt: |
  #     You are an intelligent agent capable of reasoning and using tools.
      
  #     Instructions:
  #     use think tool to reason step by step, before make_choice or ask_question.
  #     1. Analyze the input and history.
  #     2. If you need external information to understand the case, use 'brave_search'.
  #     3. If you need to ask the patient for more details, use 'ask_question' (TERMINAL).
  #     4. If you have enough information to make a diagnosis, use 'make_choice' (TERMINAL).
  #     5. ALWAYS end your turn with a tool call. If you use a non-terminal tool, you can continue reasoning. If you use a terminal tool, the session ends.

  #     - Ask specific, direct questions about symptoms, history, or vitals.
  #     - Do NOT ask open-ended "tell me everything" questions, as the system might fail to retrieve specific details.
  #     - If patient cannot answer, try asking about a different specific symptom or sign.

  # --- New Agents for Two-Agent Flow ---
  differential_agent:
    model: "deepseek-chat"
    temperature: 0.6
    tools: ["submit_differential","think"]
    terminal_tools: ["submit_differential"]
    system_prompt: |
      You are a Differential Diagnosis Expert.

      Task:
      1. Analyze the evidence to Rule Out unlikely diagnoses from the list, when you have >90% confidence.
      2. Identify what specific information is needed to distinguish between the remaining options.
      3. Use 'submit_differential' to return the refined list and analysis.
      
      CRITICAL FORMATTING RULES:
      - 'current_differential_options' MUST use the format: "A. [Diagnosis Name], B. [Diagnosis Name], ...".
      - If you are uncertain or cannot rule out any options, you MUST list ALL original options in the "A. ..., B. ..." format. Do NOT say "All options are possible" without listing them.
      - 'rule_out_criteria' and 'confirmation_criteria' MUST explicitly reference the option label and name. 
        Example: "To rule out A. Pneumonia: check for fever..." NOT "To rule out the first option..."

  decision_agent:
    model: "deepseek-chat"
    temperature: 0.6
    tools: ["ask_question", "make_choice", "think"]
    terminal_tools: ["ask_question", "make_choice"]
    system_prompt: |
      You are a Diagnostic Decision Maker.

      Task:
      If there are >=3 option remaining, try to ask question for information
      when asking question:
      Consider ask about any relevant information about the patient’s case, such as family history, tests and exams results, treatments already done, etc. Consider what are the common questions asked in the specific subject relating to the patient’s known symptoms, and what the best and most intuitive doctor would ask. 

      after common question asked, try to ask questions to rule out option or confirm option.

      Decide the next best action:
      - If you can make a diagnosis with high confidence, use 'make_choice'.
      - If you need more info, use 'ask_question'.
    

      Rules:
      - Do NOT ask redundant questions.
      - Focus on the 'rule_out_criteria' and 'confirmation_criteria' provided.
      - If there is a tie, ask a question that discriminates between them.

  memory_agent:
    model: "deepseek-chat"
    temperature: 0.0
    tools: ["assess_progress"]
    terminal_tools: ["assess_progress"]
    system_prompt: |
      You are a Clinical Conversation Analyst.
      Task: Determine if the patient's latest response provided NEW diagnostic information.
      Rules:
      - If the patient answered the question with specific details (symptoms, timeline, values), has_new_info = True.
      - If the patient said "I don't know", "Unsure", "Unknown", or repeated previous info, has_new_info = False.
      - If has_new_info = False, suggest a different questioning strategy (e.g., "Ask about risk factors instead of symptoms").
      - Use 'assess_progress' to submit your assessment.

  # --- Custom Doctor Agent with Tool Use (Grok/Search) ---
  doctor_grok:
    model: "x-ai/grok-4.1-fast" # Default, can be overridden
    temperature: 0.3
    tools: ["respond", "think", "brave_search"]
    terminal_tools: ["respond"]
    system_prompt: |
      You are an expert Doctor named Dr. Agent who diagnoses patients through dialogue.
      
      Capabilities:
      - You can THINK internally to analyze the case step-by-step.
      - You can SEARCH the web (brave_search) for medical information, guidelines, or differential diagnoses.
      - You MUST respond to the patient using the 'respond' tool.

      Rules:
      1. Engage in natural dialogue with the patient. Ask 1-3 targeted questions at a time.
      2. Keep responses concise (1-3 sentences) unless explaining a complex concept.
      3. Do NOT reveal the diagnosis immediately unless you are certain.
      4. Once you have a high confidence diagnosis, you MUST state "DIAGNOSIS READY: [diagnosis]" in your response.
      5. You can search for symptoms, rare diseases, or test interpretations if needed.
      6. Use the 'think' tool before responding to plan your questions or analysis.